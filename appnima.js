/* appnima v1.01.23 - 2014/1/23
   http://appnima.com
   Copyright (c) 2014  - Licensed  */
(function(){var Appnima,_ref,_ref1,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};window.Appnima=Appnima={},Appnima.version="1.01.07",Appnima.key=null,Appnima.token=null,Appnima.production=!0,Appnima.Dom="undefined"!=typeof $$&&null!==$$?$$:$,Appnima.onError=null,Appnima.connect=function(type,url,parameters,token,multipart){var attributes,error,headers,promise,_this=this;null==token&&(token=!1),null==multipart&&(multipart=!1),headers={},token&&null!=Appnima.key&&(headers={Authorization:"basic "+Appnima.key}),!token&&Appnima.key&&(headers={Authorization:"bearer "+Appnima.token}),promise=new Hope.Promise;try{attributes={url:url,type:type,headers:headers,data:parameters,success:function(response){return response?promise.done(null,response):promise.done("Unknown error",null)},error:function(type,xhr){var error,response;return"string"!=typeof type&&(xhr=type),response=null!=xhr.response?xhr.response:xhr.responseText,error={code:xhr.status,type:xhr.statusText,message:JSON.parse(response).message},promise.done(error,null),null!=Appnima.onError?Appnima.onError.call(_this,error):void 0}},multipart===!0?(attributes.processData=!1,attributes.contentType=!1):(attributes.dataType="json",attributes.contentType="application/x-www-form-urlencoded"),this.Dom.ajax(attributes)}catch(_error){error=_error,promise.done(error,null)}return promise},Appnima.connectMultipart=function(type,url,parameters,callbacks){var formData,name,onLoadComplete,promise,value,xhr;null==callbacks&&(callbacks={}),promise=new Hope.Promise,formData=new FormData;for(name in parameters)value=parameters[name],formData.append(name,value);return xhr=new XMLHttpRequest,xhr.responseType="json",onLoadComplete=function(){return promise.done(null,this.response)},xhr.addEventListener("load",onLoadComplete,!1),callbacks.progress&&xhr.upload.addEventListener("progress",callbacks.progress,!1),callbacks.error&&xhr.addEventListener("error",callbacks.error,!1),callbacks.abort&&xhr.addEventListener("abort",callbacks.abort,!1),xhr.open("POST",url),xhr.setRequestHeader("Authorization","bearer "+Appnima.token),xhr.send(formData),promise},Appnima.Instance=function(app){var INSTANCES,get;return INSTANCES={DEV:{user:"http://localhost:1337/",messenger:"http://localhost:1337/messenger/",network:"http://localhost:1337/network/",location:"http://localhost:1337/location/",storage:"http://localhost:1337/storage/",socket:"http://localhost:3000/socket/",rtc:"http://localhost:3001/rtc/",push:"http://localhost:1337/"},PRO:{user:"http://api.appnima.com/",messenger:"http://api.appnima.com/messenger/",network:"http://api.appnima.com/network/",location:"http://api.appnima.com/location/",storage:"http://api.appnima.com/storage/",socket:"http://api.appnima.com:3000/socket/",rtc:"http://api.appnima.com:3001/rtc/",push:"http://api.appnima.com/"}},get=function(name){return INSTANCES[app.production?"PRO":"DEV"][name]},{get:get}}(Appnima),Appnima.Location=function(app){var add,checkin,checkins,friends,people,place,places,user,_find,_url;return places=function(latitude,longitude,precision,meters,type){var parameters;return null==meters&&(meters=5e3),null==type&&(type=null),parameters={latitude:latitude,longitude:longitude},null!=precision&&(parameters.precision=precision),null==precision&&(parameters.radius=meters),app.connect("GET",""+_url()+"places",parameters)},place=function(id,reference){var parameters;return parameters={id:id},null!=reference&&(parameters.reference=reference),app.connect("GET",""+_url()+"place",parameters)},add=function(name,address,locality,postal_code,country,latitude,longitude,mail,phone,website){var parameters;return parameters={name:name,address:address,locality:locality,postal_code:postal_code,country:country,latitude:latitude,longitude:longitude},null!=mail&&(parameters.mail=mail),null!=phone&&(parameters.phone=phone),null!=website&&(parameters.website=website),app.connect("POST",""+_url()+"place",parameters)},checkin=function(id){return app.connect("POST",""+_url()+"checkin",{id:id})},checkins=function(user){return app.connect("GET",""+_url()+"checkin",{user:user})},friends=function(latitude,longitude,meters){return null==meters&&(meters=5e3),_find("friends",latitude,longitude,meters)},people=function(latitude,longitude,meters){return null==meters&&(meters=5e3),_find("people",latitude,longitude,meters)},user=function(latitude,longitude){var parameters;return parameters={latitude:null!=latitude?latitude:void 0,longitude:null!=longitude?longitude:void 0},null!=parameters.latitude&&null!=parameters.longitude?app.connect("POST",""+_url()+"user",parameters):app.connect("GET",""+_url()+"user")},_find=function(method,latitude,longitude,meters){var parameters;return null==meters&&(meters=5e3),parameters={latitude:latitude,longitude:longitude,radius:meters},app.connect("GET",""+_url()+method,parameters)},_url=function(){return app.Instance.get("location")},{places:places,place:place,add:add,checkin:checkin,checkins:checkins,people:people,friends:friends,user:user}}(Appnima),Appnima.Messenger=function(app){var SMS,conversation,deleteMessage,mail,message,messageInbox,messageOutbox,readMessage,search,summary,_messageState,_url;return mail=function(user,subject,message){var parameters;return parameters={user:user,subject:subject,message:message},app.connect("POST",""+_url()+"mail",parameters)},message=function(user,message,subject){var parameters;return parameters={user:user,message:message,subject:subject},app.connect("POST",""+_url()+"message",parameters)},SMS=function(user,message){var parameters;return parameters={user:user,message:message},app.connect("POST",""+_url()+"sms",parameters)},messageInbox=function(){return app.connect("GET",""+_url()+"message/inbox",{})},messageOutbox=function(){return app.connect("GET",""+_url()+"message/outbox",{})},summary=function(){return app.connect("GET",""+_url()+"summary")},search=function(query){var parameters;return parameters={query:query},app.connect("GET",""+_url()+"search",parameters)},conversation=function(username){var parameters;return parameters={username:username},app.connect("GET",""+_url()+"conversation",parameters)},readMessage=function(message){return _messageState(message,"READ")},deleteMessage=function(message){return _messageState(message,"DELETED")},_messageState=function(message,state){var parameters;return parameters={message:message,state:state},app.connect("PUT",""+_url()+"message",parameters)},_url=function(){return app.Instance.get("messenger")},{mail:mail,SMS:SMS,message:message,readMessage:readMessage,deleteMessage:deleteMessage,messageInbox:messageInbox,messageOutbox:messageOutbox,summary:summary,conversation:conversation,search:search}}(Appnima),Appnima.Network=function(app){var check,follow,followers,following,friends,info,search,unfollow,_errorParameters,_relationship,_url;return info=function(user_id){var parameters;return parameters=user_id?{user:user_id}:null,app.connect("GET",""+_url()+"info",parameters)},following=function(user_id,page,num_results){var parameters;return null==page&&(page=null),null==num_results&&(num_results=null),parameters={},user_id&&(parameters.user=user_id),page&&(parameters.page=page),num_results&&(parameters.num_results=num_results),app.connect("GET",""+_url()+"following",parameters)},followers=function(user_id,page,num_results){var parameters;return null==page&&(page=null),null==num_results&&(num_results=null),parameters={},user_id&&(parameters.user=user_id),page&&(parameters.page=page),num_results&&(parameters.num_results=num_results),app.connect("GET",""+_url()+"followers",parameters)},friends=function(){return app.connect("GET",""+_url()+"friends")},follow=function(user_id){return _relationship("POST","follow",user_id)},check=function(user_id){return _relationship("GET","check",user_id)},unfollow=function(user_id){return _relationship("POST","unfollow",user_id)},search=function(query){return app.connect("GET",""+_url()+"search",{query:query})},_relationship=function(type,method,user_id){var promise;return promise=new Hope.Promise,user_id?app.connect(type,""+_url()+method,{user:user_id}).then(function(error,result){return promise.done(error,result)}):promise.done({code:1,message:"Insuficient parameters",type:"Client"},null),promise},_errorParameters=function(){return this},_url=function(){return app.Instance.get("network")},{info:info,following:following,followers:followers,friends:friends,check:check,follow:follow,unfollow:unfollow,search:search}}(Appnima),Appnima.Network.Post=function(app){var comments,counter,create,createComment,deleteComment,get,like,likeUsers,remove,search,timeline,update,userLike,_url;return create=function(content,title,image){var parameters;return parameters={},content&&(parameters.content=content),title&&(parameters.title=title),image&&(parameters.image=image),app.connect("POST",""+_url()+"post",parameters)},update=function(id,content,title,image){var parameters;return parameters={},parameters.id=id,content&&(parameters.content=content),title&&(parameters.title=title),image&&(parameters.image=image),app.connect("PUT",""+_url()+"post",parameters)},remove=function(id){return app.connect("DELETE",""+_url()+"post",{id:id})},get=function(id){return app.connect("GET",""+_url()+"post",{id:id})},search=function(query,page,num_results,last_data){var parameters;return parameters={},parameters.query=query,page&&(parameters.page=page),num_results&&(parameters.num_results=num_results),last_data&&(parameters.last_data=last_data),app.connect("GET",""+_url()+"post/search",parameters)},counter=function(id){var parameters;return parameters={},id&&(parameters.user=id),app.connect("GET",""+_url()+"post/user",parameters)},timeline=function(username,page,num_results,last_data){var parameters;return parameters={},username&&(parameters.username=username),page&&(parameters.page=page),num_results&&(parameters.num_results=num_results),last_data&&(parameters.last_data=last_data),app.connect("GET",""+_url()+"post/timeline",parameters)},comments=function(id){return app.connect("GET",""+_url()+"post/comment",{id:id})},createComment=function(id,content){var parameters;return parameters={},parameters.id=id,parameters.content=content,app.connect("POST",""+_url()+"post/comment",parameters)},deleteComment=function(id){return app.connect("DELETE",""+_url()+"post/comment",{id:id})},likeUsers=function(post){return app.connect("GET",""+_url()+"post/like/users",{post:post})},userLike=function(username,page,num_results,last_data){var parameters;return parameters={},username&&(parameters.username=username),page&&(parameters.page=page),num_results&&(parameters.num_results=num_results),last_data&&(parameters.last_data=last_data),app.connect("GET",""+_url()+"post/user/like",parameters)},like=function(post){return app.connect("POST",""+_url()+"post/like",{post:post})},_url=function(){return app.Instance.get("network")},{create:create,update:update,remove:remove,search:search,counter:counter,get:get,timeline:timeline,comments:comments,createComment:createComment,deleteComment:deleteComment,likeUsers:likeUsers,userLike:userLike,like:like}}(Appnima),Appnima.Push=function(app){var received,send,_url;return send=function(user,alert,content){var parameters;return parameters={user:user,alert:alert,content:JSON.stringify(content)},app.connect("POST",""+_url()+"push",parameters)},received=function(){return this},_url=function(){return app.Instance.get("push")},{send:send,received:received}}(Appnima),Appnima.Socket=function(){function Socket(id,type){var _this=this;null==type&&(type=null),this.onMessage=__bind(this.onMessage,this),this.onDisconnect=__bind(this.onDisconnect,this),this.onError=__bind(this.onError,this),this.onDisallow=__bind(this.onDisallow,this),this.onConnect=__bind(this.onConnect,this),this.send=__bind(this.send,this),this.disallowUsers=__bind(this.disallowUsers,this),this.allowUsers=__bind(this.allowUsers,this),this.disconnect=__bind(this.disconnect,this),this.connect=__bind(this.connect,this),this.create=__bind(this.create,this),this.socket=io.connect(_url(),{"force new connection":!0}),null!=id&&this.connect(id,type),this.socket.on("connect",function(){return _this.connected=!0})}var _url;return Socket.prototype.create=function(id,type,persistent,name,allowedUsers){var _this=this;return null==persistent&&(persistent=!0),null==name&&(name=""),null==allowedUsers&&(allowedUsers=[]),this.connected?this.socket.emit("open",Appnima.token,id,name,type,persistent,allowedUsers):this.socket.on("connect",function(){return _this.connected=!0,_this.socket.emit("open",Appnima.token,id,name,type,persistent,allowedUsers)})},Socket.prototype.connect=function(id,type){var _this=this;return null==type&&(type=null),this.connected?this.socket.emit("join",Appnima.token,id,type):(this.connected=!0,this.socket.on("connect",function(){return _this.socket.emit("join",Appnima.token,id,type)}))},Socket.prototype.disconnect=function(){return this.socket.emit("leave")},Socket.prototype.allowUsers=function(users){return null==users&&(users=[]),this.socket.emit("allowUsers",users)},Socket.prototype.disallowUsers=function(users){return null==users&&(users=[]),this.socket.emit("disallowUsers",users)},Socket.prototype.send=function(message,type,optionalData){return null==type&&(type="text"),null==optionalData&&(optionalData={}),this.socket.emit("sendMessage",{content:message,type:type,data:optionalData})},Socket.prototype.broadcast=function(message,type,optionalData){return null==type&&(type="text"),null==optionalData&&(optionalData={}),this.socket.emit("sendBroadcast",{content:message,type:type,data:optionalData})},Socket.prototype.onConnect=function(callback){return this.socket.on("onConnection",function(message){return callback(message)})},Socket.prototype.onDisallow=function(callback){return this.socket.on("onDisallowUsers",function(users){return callback(users)})},Socket.prototype.onError=function(callback){var _this=this;return this.socket.on("onError",function(message){return-1!==message.indexOf("[CONNECTION ERROR]")&&_this.disconnect(),callback(message)})},Socket.prototype.onDisconnect=function(callback){return this.socket.on("disconnect",callback)},Socket.prototype.onMessage=function(callback){return this.socket.on("onMessage",function(message){return callback(message)})},Socket.prototype.api=function(type,method,parameters){return Appnima.connect(type,""+Appnima.Instance.get("user")+method,parameters)},_url=function(){return Appnima.Instance.get("socket")},Socket}(),Appnima.Socket.Group=function(_super){function Group(){return _ref=Group.__super__.constructor.apply(this,arguments)}return __extends(Group,_super),Group.prototype.create=function(name,users,persistent){return null==users&&(users=[]),null==persistent&&(persistent=!0),Group.__super__.create.call(this,null,"private",persistent,name,users)},Group.prototype.list=function(){return this.api("GET","socket/room")},Group.prototype.remove=function(id){return this.api("DELETE","socket/room",{id:id})},Group.prototype.rename=function(id,name){return this.api("PUT","socket/room",{id:id,name:name})},Group.prototype.deleteUnreadCount=function(room){return this.api("DELETE","socket/message/unread",{room:room})},Group.prototype.messages=function(room,page){return this.api("GET","socket/message",{room:room,page:page})},Group.prototype.updateMessage=function(room,type,new_type){return this.socket.emit("updateMessage",{room:room,type:type,new_type:new_type})},Group}(Appnima.Socket),Appnima.Socket.Chat=function(_super){function Chat(){return _ref1=Chat.__super__.constructor.apply(this,arguments)}return __extends(Chat,_super),Chat.prototype.create=function(name,users){return null==users&&(users=[]),Chat.__super__.create.call(this,name,users,!1)},Chat}(Appnima.Socket.Group),Appnima.Socket.Emiter=function(_super){function Emiter(id){Emiter.__super__.constructor.call(this,null),this.create(id,"public",!1,id)}return __extends(Emiter,_super),Emiter}(Appnima.Socket),Appnima.Socket.Listener=function(_super){function Listener(id){Listener.__super__.constructor.call(this,id,"public")}return __extends(Listener,_super),Listener}(Appnima.Socket),Appnima.Socket.Application=function(_super){function Application(){Application.__super__.constructor.call(this,null),this.connect(null)}return __extends(Application,_super),Application}(Appnima.Socket),Appnima.Socket.Inbox=function(_super){function Inbox(){Inbox.__super__.constructor.call(this,null),this.create(null,"inbox",!1)}return __extends(Inbox,_super),Inbox.prototype.unreadCounts=function(){return this.api("GET","socket/message/unread")},Inbox.prototype.onOnlineFriends=function(callback){return null!=callback&&this.socket.on("onOnlineFriends",function(users){return callback(users)}),this.socket.emit("onlineFriends",Appnima.token)},Inbox.prototype.onFriendConnected=function(callback){return this.socket.on("friendConnected",function(user){return callback(user)})},Inbox.prototype.onFriendDisconnected=function(callback){return this.socket.on("friendDisconnected",function(user){return callback(user)})},Inbox.prototype.sendToFollowers=function(data){return this.socket.emit("sendToFollowers",Appnima.token,data)},Inbox.prototype.sendToFriends=function(data){return this.socket.emit("sendToFriends",Appnima.token,data)},Inbox.prototype.sendToUser=function(id,data){return this.socket.emit("sendToUser",Appnima.token,id,data)},Inbox}(Appnima.Socket),Appnima.Socket.User=function(_super){function User(){User.__super__.constructor.apply(this,arguments)}return __extends(User,_super),User}(Appnima.Socket),Appnima.Storage=function(app){var activityFile,allowAccessFile,createFolder,deleteFile,deleteFolder,denyAccessFile,dir,download,publicURLFile,renameFile,renameFolder,search,upload,_url;return dir=function(folder){return app.connect("GET",""+_url()+"folder",{folder:folder})},createFolder=function(name,path){var parameters;return parameters={name:name,path:path},app.connect("POST",""+_url()+"folder",parameters)},renameFolder=function(path,name){var parameters;return parameters={path:path,name:name},app.connect("PUT",""+_url()+"folder",parameters)},deleteFolder=function(path){return app.connect("DELETE",""+_url()+"folder",{path:path})},upload=function(file,path,callbacks){var parameters,promise;return null==callbacks&&(callbacks={}),promise=new Hope.Promise,parameters={file:file,path:path},app.connectMultipart("POST",""+_url()+"file",parameters,callbacks)},download=function(file_id){return window.location=""+_url()+"file/"+file_id+"_"+Appnima.token},activityFile=function(id_file){return app.connect("GET",""+_url()+"activity",{id_file:id_file})},renameFile=function(id,name){var parameters;return parameters={id:id,name:name},app.connect("PUT",""+_url()+"file",parameters)},deleteFile=function(id){return app.connect("DELETE",""+_url()+"file",{id:id})},search=function(term){return app.connect("POST",""+_url()+"search",{term:term})},publicURLFile=function(file_id,isPublic){var parameters;return parameters={id:file_id,isPublic:isPublic},app.connect("POST",""+_url()+"file/share",parameters)},allowAccessFile=function(id_file,id_user){var parameters;return parameters={id_file:id_file,id_user:id_user},app.connect("PUT",""+_url()+"file/allow",parameters)},denyAccessFile=function(id_file,id_user){var parameters;return parameters={id_file:id_file,id_user:id_user},app.connect("PUT",""+_url()+"file/disallow",parameters)},_url=function(){return app.Instance.get("storage")},{upload:upload,download:download,renameFile:renameFile,deleteFile:deleteFile,search:search,publicURLFile:publicURLFile,createFolder:createFolder,renameFolder:renameFolder,deleteFolder:deleteFolder,dir:dir,allowAccessFile:allowAccessFile,denyAccessFile:denyAccessFile,activityFile:activityFile}}(Appnima),Appnima.User=function(app){var avatar,info,login,logout,password,session,signup,subscribe,terminal,ticket,token,update,_credentials,_storage,_url;return signup=function(mail,password,username){var parameters,promise;return promise=new Hope.Promise,parameters={password:password,username:null!=username?username:mail},null!=mail&&(parameters.mail=mail),Hope.chain([function(){return app.connect("POST",""+_url()+"user/signup",parameters,token)},function(error,profile){var storage;return storage=_storage(profile),parameters.grant_type="refresh_token",parameters.refresh_token=profile.refresh_token,app.connect("POST",""+_url()+"user/token",parameters,!0)}]).then(function(error,token){return _credentials(promise,error,token)}),promise},token=function(){var parameters,promise,storage;return promise=new Hope.Promise,storage=_storage(),parameters={refresh_token:storage.refresh_token,grant_type:"refresh_token"},app.connect("POST",""+_url()+"user/token",parameters,!0).then(function(error,token){return _credentials(promise,error,token)}),promise},session=function(){var storage;return storage=JSON.parse(localStorage.getItem(app.key)),storage&&(Appnima.token=storage.access_token,app.connect("GET",""+_url()+"user/info").then(function(error,result){return _storage(result)})),storage},login=function(mail,password,username){var parameters,promise;return promise=new Hope.Promise,parameters={password:password,username:null!=username?username:null},null!=mail&&(parameters.mail=mail),app.connect("POST",""+_url()+"user/login",parameters,!0).then(function(error,profile){return _credentials(promise,error,profile)}),promise},logout=function(){var promise;return promise=new Hope.Promise,setTimeout(function(){return localStorage.removeItem(app.key),promise.done(null,{status:"ok"})},300),promise},info=function(user){return user?app.connect("GET",""+_url()+"user/info",{user:user}):app.connect("GET",""+_url()+"user/info")},update=function(data){return app.connect("PUT",""+_url()+"user/info",data)},avatar=function(data){return app.connect("POST",""+_url()+"user/avatar",{avatar:data},!1)},password=function(old_password,new_password){var parameters;return parameters={old_password:old_password,new_password:new_password},app.connect("POST",""+_url()+"user/password",parameters,!1)},terminal=function(os,type,token,version){var method,parameters;return method="GET",parameters={},null!=os&&(method="POST",parameters={os:os,token:token,type:type,version:version}),app.connect(method,""+_url()+"user/terminal",parameters)},subscribe=function(mail){return app.connect("POST",""+_url()+"user/subscription",{mail:mail},!0)},ticket=function(type,question){var parameters;return parameters={type:type,question:question},app.connect("POST",""+_url()+"user/ticket",parameters)},_url=function(){return app.Instance.get("user")},_credentials=function(promise,error,result){return error?promise.done(error,null):promise.done(null,_storage(result))},_storage=function(extend){var attribute,storage;if(storage=JSON.parse(localStorage.getItem(app.key))||{},extend){for(attribute in extend)storage[attribute]=extend[attribute];localStorage.setItem(app.key,JSON.stringify(storage)),null!=storage.access_token&&(Appnima.token=storage.access_token)}return storage},{signup:signup,token:token,login:login,logout:logout,session:session,info:info,update:update,avatar:avatar,password:password,terminal:terminal,subscribe:subscribe,ticket:ticket}}(Appnima),Appnima.Rtc=function(){var CHUNK_LENGTH,ICE_SERVERS,IceCandidate,OPTIONS,PeerConnection,SessionDescription;return ICE_SERVERS={iceServers:[{url:"stun:stun.l.google.com:19302"}]},OPTIONS={optional:[{RtpDataChannels:!0}]},CHUNK_LENGTH=1e3,PeerConnection=function(){var peer_connection,_ref2;return new(peer_connection=null!=(_ref2=window.mozRTCPeerConnection)?_ref2:window.webkitRTCPeerConnection)(ICE_SERVERS,OPTIONS)},SessionDescription=function(remote){var session_description;return new(session_description="undefined"!=typeof RTCSessionDescription&&null!==RTCSessionDescription?RTCSessionDescription:mozRTCSessionDescription)(remote)},IceCandidate=function(candidate){var ice_candidate,_ref2;return new(ice_candidate=null!=(_ref2=window.mozRTCIceCandidate)?_ref2:window.RTCIceCandidate)(candidate)},{CHUNK_LENGTH:CHUNK_LENGTH,PeerConnection:PeerConnection,SessionDescription:SessionDescription,IceCandidate:IceCandidate}}(Appnima),Appnima.Peer=function(){function Peer(){this._answer=__bind(this._answer,this),this._status=__bind(this._status,this),this._offer=__bind(this._offer,this),this._refresh=__bind(this._refresh,this),this._hangUp=__bind(this._hangUp,this),this._connected=__bind(this._connected,this),this._ice=__bind(this._ice,this),this.onNewIceCandidate=__bind(this.onNewIceCandidate,this),this._sendChunckedFile=__bind(this._sendChunckedFile,this);var event,_i,_len,_ref2;for(Appnima.Signaling=io.connect(Appnima.Instance.get("rtc")),this.connected=!1,this.connected_user_id=null,this.callbacks={},this.pc=Appnima.Rtc.PeerConnection(),this.pc.onicecandidate=this.onNewIceCandidate,_ref2=this.events,_i=0,_len=_ref2.length;_len>_i;_i++)event=_ref2[_i],Appnima.Signaling.on(event,this["_"+event]);this.connect()}var saveToDisk,_configureOptions,_uid;return Peer.prototype.events=["offer","answer","ice","connected","status","refresh","hangUp","error"],Peer.prototype.connect=function(){return Appnima.Signaling.emit("connect",Appnima.token)},Peer.prototype.addMedia=function(media){var _this=this;return this.media=media,this.pc.addStream(this.media),this.pc.onaddstream=function(event){return _this.trigger("remoteStream",event.stream)}},Peer.prototype.createChannel=function(){var _this=this;return this.fileChunks={},this.channel=this.pc.createDataChannel("RTCDataChannel",{reliable:!0}),this.channel.onmessage=function(event){var data;return data=JSON.parse(event.data),"object"===data.type&&_this.trigger("data",data.message),"file"===data.type&&(_this.fileChunks[data.uid]||(_this.fileChunks[data.uid]=[]),_this.fileChunks[data.uid].push(data.message),data.last)?(saveToDisk(_this.fileChunks[data.uid].join(""),data.name),delete _this.fileChunks[data.uid]):void 0}},Peer.prototype.offer=function(user_id,only_audio,only_text){var options,_this=this;return null==only_audio&&(only_audio=!1),null==only_text&&(only_text=!1),this.offerer=!0,options=_configureOptions(only_text,only_audio),this.pc.createOffer(function(description){return _this.pc.setLocalDescription(description),Appnima.Signaling.emit("offer",user_id,description)},null,options)},Peer.prototype.accept=function(user_id,remote_description,only_audio,only_text){var options,_this=this;return null==only_audio&&(only_audio=!1),null==only_text&&(only_text=!1),this.offerer=!1,options=_configureOptions(only_text,only_audio),this.pc.setRemoteDescription(Appnima.Rtc.SessionDescription(remote_description)),this.pc.createAnswer(function(description){return _this.pc.setLocalDescription(description),Appnima.Signaling.emit("answer",user_id,description)},null,options)},Peer.prototype.send=function(data){return this.channel?this.channel.send(JSON.stringify({type:"object",message:data})):(console.error("Channel not created yet"),console.debug("use <PeerName>.createChannel() before this call"))},Peer.prototype.sendFile=function(file){var reader,uid,_this=this;return file?(reader=new FileReader,uid=_uid(),reader.onload=function(event){return _this._sendChunckedFile(event,file.name,uid)},reader.readAsDataURL(file)):console.error("Not file provided")},Peer.prototype.hangUp=function(user_id,stream){return null==user_id&&(user_id=null),null==stream&&(stream=null),Appnima.Signaling.emit("hangUp",user_id),null!=stream?this.refreshConnection(stream):void 0},Peer.prototype.refreshFriendsList=function(){return Appnima.Signaling.emit("refresh")},Peer.prototype.statusChange=function(available){return null==available&&(available=!0),Appnima.Signaling.emit("status",available)},Peer.prototype.disconnect=function(){return Appnima.Signaling.emit("disconnect")},Peer.prototype.refreshConnection=function(stream){return null!=stream&&stream.stop(),this.pc.close(),this.pc=Appnima.Rtc.PeerConnection(),this.pc.onicecandidate=this.onNewIceCandidate,this.createChannel()},Peer.prototype._sendChunckedFile=function(event,name,uid,text){var data,remainingDataURL,_this=this;return text||(text=event.target.result),data={type:"file",name:name,uid:uid},text.length>Appnima.Rtc.CHUNK_LENGTH?data.message=text.slice(0,Appnima.Rtc.CHUNK_LENGTH):(data.message=text,data.last=!0),this.channel.send(JSON.stringify(data)),remainingDataURL=text.slice(data.message.length),remainingDataURL.length?setTimeout(function(){return _this._sendChunckedFile(null,name,uid,remainingDataURL)},500):void 0},saveToDisk=function(fileUrl,fileName){var evt,save;return save=document.createElement("a"),save.href=fileUrl,save.target="_blank",save.download=fileName||fileUrl,evt=document.createEvent("MouseEvents"),evt.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),save.dispatchEvent(evt),(window.URL||window.webkitURL).revokeObjectURL(save.href)},Peer.prototype.onNewIceCandidate=function(ice){return ice.candidate&&!this.offerer?(this.pc.addIceCandidate(Appnima.Rtc.IceCandidate(ice.candidate)),Appnima.Signaling.emit("ice",this.connected_user_id,ice)):void 0},Peer.prototype._ice=function(ice){return this.offerer&&ice.candidate?this.pc.addIceCandidate(Appnima.Rtc.IceCandidate(ice.candidate)):void 0},Peer.prototype._connected=function(friends){return this.connected=!0,this.trigger("connected",friends)},Peer.prototype._hangUp=function(friend){return this.trigger("hangUp",friend)},Peer.prototype._refresh=function(friends){return this.trigger("refresh",friends)},Peer.prototype._offer=function(data){return this.connected_user_id=data.user.id,this.trigger("offer",data)},Peer.prototype._status=function(type,friend){return this.trigger(type,friend)},Peer.prototype._answer=function(data){return this.pc.setRemoteDescription(Appnima.Rtc.SessionDescription(data.description)),this.trigger("answer",data)},Peer.prototype._error=function(error){return console.error("[ERROR] :: ",error)},Peer.prototype.on=function(event,callback){return this.callbacks[event]=callback},Peer.prototype.trigger=function(event,data){return this.callbacks[event]?this.callbacks[event].call(this.callbacks[event],data):void 0},_configureOptions=function(only_text,only_audio){var channels;return channels=only_text===!0?{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}:only_audio===!0?{OfferToReceiveAudio:!0,OfferToReceiveVideo:!1}:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},{optional:[],mandatory:channels}},_uid=function(length){var i,possible,text,_i;for(null==length&&(length=20),text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=_i=0;length>=0?length>=_i:_i>=length;i=length>=0?++_i:--_i)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text},Peer}()}).call(this);